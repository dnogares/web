<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Suite Tasaci√≥n - Visor Pro</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/estilos_base.css" />
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      block-size: 100%;
      font-family: 'Inter', sans-serif;
      overflow: hidden;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Contenedor principal cuadrado y centrado */
    .main-container {
      inline-size: 90vw;
      block-size: 90vh;
      max-inline-size: 1200px;
      max-block-size: 800px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      gap: 16px;
      padding: 20px;
    }

    #map {
      grid-column: 2;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      z-index: 1;
    }

    /* √Årea de carga de archivos */
    .upload-area {
      position: absolute;
      inset-block-end: 20px;
      inset-inline-start: 320px;
      /* evitar superposici√≥n con panel izquierdo */
      inset-inline-end: 20px;
      /* overlay-aware */
      block-size: 60px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 2px dashed rgba(99, 102, 241, 0.3);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      padding: 0 20px;
      z-index: 10;
      transition: all 0.3s ease;
    }

    /* --- PANEL LATERAL IZQUIERDO (PRINCIPALES FUNCIONES) --- */
    .left-panel {
      grid-column: 1;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      color: #0f172a;
      font-size: 13px;
      overflow-y: auto;
    }

    .left-panel h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      color: #1e293b;
      font-weight: 600;
    }

    .left-panel .lp-btn {
      inline-size: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      background: #fff;
      cursor: pointer;
      font-weight: 600;
      margin-block-end: 10px;
      transition: all 0.3s ease;
    }

    .left-panel .lp-btn:hover {
      background: rgba(59, 130, 246, 0.1);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }

    .left-panel .lp-small {
      display: flex;
      gap: 8px;
      margin-block-end: 10px;
    }

    .left-panel input[type="text"],
    .left-panel textarea {
      inline-size: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #e6edf3;
      margin-block-end: 10px;
    }

    /* --- √ÅREA DE CARGA DE ARCHIVOS --- */
    .upload-area {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 2px dashed rgba(99, 102, 241, 0.3);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .upload-area:hover {
      border-color: rgba(99, 102, 241, 0.6);
      background: rgba(255, 255, 255, 0.9);
    }

    .file-input {
      display: none;
    }

    .upload-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.3s ease;
      margin-block-end: 8px;
    }

    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .upload-text {
      color: #64748b;
      font-size: 12px;
    }

    .tab-nav {
      display: flex;
      gap: 8px;
      margin-block-end: 16px;
      border-block-end: 1px solid rgba(0, 0, 0, 0.1);
      padding-block-end: 8px;
    }

    .tab-btn {
      padding: 8px 12px;
      border: none;
      background: transparent;
      color: #64748b;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 8px 8px 0 8px;
    }

    .tab-btn:hover {
      background: rgba(59, 130, 246, 0.1);
      color: #1e293b;
    }

    .tab-btn.active {
      background: #3b82f6;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .upload-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .file-input {
      display: none;
    }

    .upload-text {
      color: #64748b;
      font-size: 14px;
    }

    /* --- BARRA SUPERIOR GLASS --- */
    .top-nav {
      position: absolute;
      inset-block-start: 20px;
      inset-inline-start: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      gap: 15px;
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 25px;
      border: none;
      background: transparent;
      color: #1e293b;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.5);
      transform: translateY(-1px);
    }

    .nav-item.active {
      background: #3b82f6;
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    /* --- PANEL LATERAL DERECHO --- */
    .side-panel {
      grid-column: 3;
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
      color: #0f172a;
      font-size: 13px;
      overflow-y: auto;
    }

    .side-panel {
      position: fixed;
      /* overlay */
      inset-block-start: 80px;
      inset-inline-end: 20px;
      inline-size: 360px;
      max-block-size: calc(100% - 120px);
      z-index: 1400;
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.28);
      overflow-y: auto;
      color: #1e293b;
      transition: transform 0.28s ease, opacity 0.28s ease;
      transform: translateX(0);
      pointer-events: auto;
    }

    .side-panel.collapsed {
      transform: translateX(420px);
      opacity: 0;
      pointer-events: none;
    }

    .panel-section {
      margin-block-end: 25px;
    }

    .panel-section h3 {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-block-end: 15px;
      color: #64748b;
      font-weight: 600;
    }

    /* --- BOTONES DE HERRAMIENTAS --- */
    .tool-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .tool-btn {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(0, 0, 0, 0.05);
      background: white;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      font-size: 13px;
      color: #1e293b;
    }

    .tool-btn:hover {
      background: #3b82f6;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .tool-btn.danger {
      background: #fef2f2;
      color: #ef4444;
    }

    .tool-btn.danger:hover {
      background: #ef4444;
      color: white;
    }

    /* --- CAPAS (SWITCHES) --- */
    .layer-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-block-end: 12px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 8px;
      transition: all 0.3s ease;
      gap: 8px;
    }

    .layer-item:hover {
      background: rgba(255, 255, 255, 0.8);
      transform: translateX(5px);
    }

    .legend-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s ease;
      opacity: 0.7;
    }

    .legend-btn:hover {
      opacity: 1;
      background: rgba(59, 130, 246, 0.1);
      transform: scale(1.1);
    }

    input[type="checkbox"] {
      inline-size: 18px;
      block-size: 18px;
      accent-color: #3b82f6;
      cursor: pointer;
    }

    input[type="range"] {
      inline-size: 100%;
      accent-color: #3b82f6;
      margin-block-start: 8px;
      cursor: pointer;
    }

    /* --- SCROLLBAR EST√âTICA --- */
    .side-panel::-webkit-scrollbar {
      inline-size: 6px;
    }

    .side-panel::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }

    .side-panel::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
    }

    .side-panel::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* --- ESTILOS LEAFLET GLASS --- */
    .leaflet-popup-content-wrapper {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }

    .leaflet-popup-content {
      color: #1e293b;
      font-size: 14px;
    }

    .leaflet-control {
      background: rgba(255, 255, 255, 0.7) !important;
      backdrop-filter: blur(12px) !important;
      -webkit-backdrop-filter: blur(12px) !important;
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
      border-radius: 8px !important;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15) !important;
    }

    .leaflet-control a {
      color: #1e293b !important;
      font-weight: 500 !important;
    }

    .leaflet-control a:hover {
      background: rgba(255, 255, 255, 0.5) !important;
      border-radius: 4px !important;
    }

    .buttons-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 8px;
      margin-block-end: 12px;
    }

    button.action-btn {
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color: #1e293b;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    button.action-btn:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    button.action-btn.error {
      background: rgba(239, 68, 68, 0.8);
      color: white;
    }

    button.action-btn.error:hover {
      background: rgba(239, 68, 68, 0.9);
    }

    button.action-btn.info {
      background: rgba(59, 130, 246, 0.8);
      color: white;
    }

    button.action-btn.info:hover {
      background: rgba(59, 130, 246, 0.9);
    }

    .results {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-block-end: 12px;
    }

    .result-box {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 12px;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .result-box:hover {
      background: rgba(255, 255, 255, 0.8);
      transform: translateY(-2px);
    }

    .result-box h4 {
      margin: 0 0 8px 0;
      color: #3b82f6;
      font-weight: 600;
    }

    .result-box .status {
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 500;
    }

    .status.success {
      background: rgba(16, 185, 129, 0.1);
      color: #065f46;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status.error {
      background: rgba(239, 68, 68, 0.1);
      color: #991b1b;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .status.warning {
      background: rgba(245, 158, 11, 0.1);
      color: #92400e;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    .pdf-options {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 16px;
    }

    .pdf-options h4 {
      margin: 0 0 12px 0;
      color: #1e293b;
      font-size: 14px;
      font-weight: 600;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-block-end: 12px;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      cursor: pointer;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .checkbox-group label:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    .checkbox-group input[type="checkbox"] {
      inline-size: 18px;
      block-size: 18px;
      accent-color: #3b82f6;
      cursor: pointer;
    }

    #btnGenerarPDF {
      inline-size: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-block-start: 12px;
      transition: all 0.3s ease;
    }

    #btnGenerarPDF:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .file-upload {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 16px;
    }

    .file-upload input[type="file"] {
      display: block;
      margin-block-end: 10px;
      font-size: 13px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
    }

    #fileList {
      font-size: 12px;
      color: #64748b;
      max-block-size: 100px;
      overflow: auto;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 8px;
    }

    .file-item {
      background: rgba(255, 255, 255, 0.6);
      padding: 8px;
      margin: 4px 0;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
    }

    .file-item:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    .file-item button {
      padding: 4px 8px;
      font-size: 11px;
      background: rgba(239, 68, 68, 0.8);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .file-item button:hover {
      background: rgba(239, 68, 68, 0.9);
    }

    /* Mediciones con Glassmorphism */
    .measurement-tools {
      display: flex;
      gap: 8px;
      margin-block-end: 12px;
      flex-wrap: wrap;
    }

    .tool-btn {
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color: #1e293b;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .tool-btn:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    .tool-btn.active {
      background: rgba(59, 130, 246, 0.8);
      color: white;
    }

    #measurement-result {
      display: none;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 12px;
      margin-block-start: 12px;
      font-size: 12px;
      border-inline-start: 4px solid #3b82f6;
    }

    #measurement-result.active {
      display: block;
    }

    @media (max-inline-size:900px) {
      .visor-split {
        flex-direction: column;
      }

      #sidebar {
        inline-size: 100%;
        max-block-size: 200px;
      }
    }

    /* --- ESTILOS PARA TOOLTIPS DE MEDICI√ìN --- */
    .measurement-tooltip {
      background: rgba(255, 255, 255, 0.9) !important;
      backdrop-filter: blur(12px) !important;
      -webkit-backdrop-filter: blur(12px) !important;
      border: 1px solid rgba(255, 255, 255, 0.5) !important;
      border-radius: 12px !important;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15) !important;
      color: #1e293b !important;
      font-weight: 600 !important;
      font-size: 13px !important;
      padding: 8px 12px !important;
    }

    .measurement-tooltip-distance {
      background: rgba(59, 130, 246, 0.9) !important;
      color: white !important;
      border-color: rgba(59, 130, 246, 0.5) !important;
    }

    .measurement-tooltip-area {
      background: rgba(16, 185, 129, 0.9) !important;
      color: white !important;
      border-color: rgba(16, 185, 129, 0.5) !important;
    }
  </style>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.10.3/src/leaflet.geometryutil.min.js"></script>
</head>

<body>
  <!-- CONTENEDOR PRINCIPAL CUADRADO -->
  <div class="main-container">

    <!-- PANEL IZQUIERDO -->
    <div class="left-panel">
      <h3>üè† Visor Catastral</h3>

      <div class="panel-section">
        <h4>üìç Referencia Catastral</h4>
        <div class="lp-small">
          <input id="refInput" type="text" placeholder="Ej: 8884601WF4788S0020LL" />
          <button class="lp-btn" onclick="cargarReferenciaCatastral()">Cargar</button>
        </div>

        <div style="margin-block-start:12px;">
          <label style="font-size:12px; color:#64748b; display:block; margin-block-end:6px;">
            üìÑ Cargar lote desde archivo (TXT/CSV):
          </label>
          <input type="file" id="refs-file-input" accept=".txt,.csv" style="display:none;">
          <button class="upload-btn" style="inline-size:100%; font-size:13px;"
            onclick="document.getElementById('refs-file-input').click()">
            üìÅ Seleccionar archivo de referencias
          </button>
          <div id="refs-file-list" style="margin-block-start:8px; font-size:12px; color:#64748b;"></div>
        </div>
      </div>

      <div class="panel-section">
        <h4>üìÅ Cargar Archivos</h4>
        <div class="upload-area">
          <input type="file" id="file-input" class="file-input" multiple accept=".kml,.gml,.geojson,.json,.shp,.zip">
          <button class="upload-btn" onclick="document.getElementById('file-input').click()">
            üìÅ Seleccionar Archivos
          </button>
          <span class="upload-text">KML, GML, GeoJSON, SHP, ZIP</span>
        </div>
        <div id="file-list" style="margin-block-start:8px; font-size:12px; color:#64748b;"></div>
      </div>

      <div class="panel-section">
        <h4>üìê Herramientas</h4>
        <div class="tool-grid">
          <button class="tool-btn" onclick="toggleMeasureDistance()">
            üìè Distancia
          </button>
          <button class="tool-btn" onclick="toggleMeasureArea()">
            üìê √Årea
          </button>
          <button class="tool-btn danger" onclick="limpiarMapa()">
            üóëÔ∏è Limpiar
          </button>
        </div>
        <div id="measurement-result" style="display:none; margin-block-start:8px; font-weight:600; color:#0f172a;">
        </div>
      </div>
    </div>

    <!-- MAPA CENTRAL -->
    <div id="map"></div>

    <!-- PANEL DERECHO -->
    <div class="side-panel">
      <!-- Tabs internos -->
      <div class="panel-section">
        <div class="tab-nav">
          <button class="tab-btn active" onclick="switchInternalTab('referencia')">Referencia</button>
          <button class="tab-btn" onclick="switchInternalTab('urbanismo')">Urbanismo</button>
          <button class="tab-btn" onclick="switchInternalTab('afecciones')">Afecciones</button>
          <button class="tab-btn" onclick="switchInternalTab('pdf')">PDF</button>
        </div>
      </div>

      <!-- Contenido de tabs -->
      <div id="tab-referencia" class="tab-content">
        <div class="panel-section">
          <h4>üìç Datos de Referencia</h4>
          <div id="refDatos" style="font-size:12px; color:#64748b;">
            Carga una referencia para ver sus datos
          </div>
        </div>
      </div>

      <div id="tab-urbanismo" class="tab-content" style="display:none;">
        <div class="panel-section">
          <h4>üèôÔ∏è An√°lisis Urban√≠stico</h4>
          <!-- Opci√≥n 1: Referencia catastral -->
          <div style="margin-block-end: 15px;">
            <label style="font-weight: bold; color: #2b7db3; display: block; margin-block-end: 6px;">üìç Usar referencia catastral:</label>
            <div style="display: flex; gap: 8px;">
              <input id="urbanismoRefInput" type="text" placeholder="Ej: 8884601WF4788S0020LL" 
                     style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <button class="action-btn info" onclick="analizarUrbanismoDesdeRef()">Analizar</button>
            </div>
          </div>
          <!-- Opci√≥n 2: Archivo vectorial -->
          <div style="margin-block-end: 15px;">
            <label style="font-weight: bold; color: #2b7db3; display: block; margin-block-end: 6px;">üìÅ O cargar archivo vectorial:</label>
            <input id="fileUrbanismo" type="file" accept=".kml,.gml,.geojson,.json,.gpkg"
                   style="inline-size: 100%; margin-block-end: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
            <button class="action-btn" style="inline-size: 100%;" onclick="analizarUrbanismoDesdeArchivo()">Cargar y Analizar</button>
          </div>
          <div id="urbanismoResult" style="margin-block-start:10px; font-size:12px;"></div>
        </div>
      </div>

      <div id="tab-afecciones" class="tab-content" style="display:none;">
        <div class="panel-section">
          <h4>‚ö†Ô∏è An√°lisis de Afecciones</h4>
          <!-- Opci√≥n 1: Referencia catastral -->
          <div style="margin-block-end: 15px;">
            <label style="font-weight: bold; color: #e74c3c; display: block; margin-block-end: 6px;">üìç Usar referencia catastral:</label>
            <div style="display: flex; gap: 8px;">
              <input id="afeccionesRefInput" type="text" placeholder="Ej: 8884601WF4788S0020LL" 
                     style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <button class="action-btn error" onclick="analizarAfeccionesDesdeRef()">Analizar</button>
            </div>
          </div>
          <!-- Opci√≥n 2: Archivo vectorial -->
          <div style="margin-block-end: 15px;">
            <label style="font-weight: bold; color: #e74c3c; display: block; margin-block-end: 6px;">üìÅ O cargar archivo vectorial:</label>
            <input id="fileAfecciones" type="file" multiple accept=".kml,.gml,.geojson,.json,.gpkg"
                   style="inline-size: 100%; margin-block-end: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
            <button class="action-btn" style="inline-size: 100%;" onclick="analizarAfeccionesDesdeArchivo()">Cargar y Analizar</button>
          </div>
          <div id="afeccionesResult" style="margin-block-start:10px; font-size:12px;"></div>
        </div>
      </div>

      <div id="tab-pdf" class="tab-content" style="display:none;">
        <div class="panel-section">
          <h4>üìÑ Generar Informe</h4>
          <button class="action-btn" onclick="generarPDF()">Generar PDF</button>
          <div id="pdfResult" style="margin-block-start:10px; font-size:12px;"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- BARRA SUPERIOR GLASS -->
  <nav class="top-nav">
    <button class="nav-item active" onclick="switchTab('visor')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"
        style="margin-inline-end: 8px;">
        <polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21" />
        <line x1="9" y1="3" x2="9" y2="18" />
        <line x1="15" y1="6" x2="15" y2="21" />
      </svg>
      Visor GIS
    </button>
    <button class="nav-item" onclick="switchTab('referencia')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"
        style="margin-inline-end: 8px;">
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
        <circle cx="12" cy="10" r="3" />
      </svg>
      Referencia
    </button>
    <button class="nav-item" onclick="switchTab('analisis')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"
        style="margin-inline-end: 8px;">
        <line x1="18" y1="20" x2="18" y2="10" />
        <line x1="12" y1="20" x2="12" y2="4" />
        <line x1="6" y1="20" x2="6" y2="14" />
      </svg>
      An√°lisis
    </button>
    <button class="nav-item" onclick="switchTab('pdf')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"
        style="margin-inline-end: 8px;">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
        <polyline points="14 2 14 8 20 8" />
      </svg>
      PDF
    </button>
    <button id="btnToggleSidebar" class="nav-item" title="Mostrar / Ocultar panel" onclick="toggleSidebar()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"
        style="margin-inline-end: 8px;">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      Panel
    </button>
  </nav>

  <!-- PANEL LATERAL IZQUIERDO: 3 FUNCIONES PRINCIPALES -->
  <div class="left-panel" id="leftPanel">
    <h4>Funciones principales</h4>

    <div style="margin-block-end:10px;">
      <strong>1) Obtener datos</strong>
      <input id="leftRefInput" type="text" placeholder="Referencia (ej: 8884601WF4788S0020LL)"
        style="margin-block:8px;" />
      <div class="lp-small">
        <button class="lp-btn" onclick="leftLoadRef()">Cargar referencia</button>
        <button class="lp-btn" onclick="openRefsTab()">Cargar lote</button>
      </div>
      <div style="font-size:12px; color:#64748b;">Tambi√©n puedes pegar varias referencias en la pesta√±a
        <strong>Referencia</strong>.</div>
    </div>

    <div style="margin-block-end:10px;">
      <strong>2) An√°lisis Urban√≠stico</strong>
      <div style="margin-block-start:8px; display:flex; gap:8px; flex-direction:column;">
        <button class="lp-btn" onclick="document.getElementById('btnUrbanismo').click()">Ejecutar an√°lisis</button>
        <button class="lp-btn" onclick="document.getElementById('fileUrbanismo').click()">Cargar KML/GML</button>
      </div>
    </div>

    <div>
      <strong>3) An√°lisis de Afecciones</strong>
      <div style="margin-block-start:8px; display:flex; gap:8px; flex-direction:column;">
        <button class="lp-btn" onclick="document.getElementById('btnAfecciones').click()">Ejecutar an√°lisis</button>
        <button class="lp-btn" onclick="document.getElementById('fileAfecciones').click()">Cargar archivos</button>
      </div>
    </div>
  </div>

  <!-- PANEL LATERAL DERECHO -->
  <div class="side-panel">
    <div class="panel-section">
      <h3>Medici√≥n</h3>
      <div class="tool-grid">
        <button class="tool-btn" onclick="activarDistancia()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"
            style="margin-inline-end: 5px;">
            <path
              d="M21.3 15.3l-9.3-9.3c-.4-.4-1-.4-1.4 0L3.3 13.3c-.4.4-.4 1 0 1.4l9.3 9.3c.4.4 1 .4 1.4 0l7.3-7.3c.4-.4.4-1 0-1.4z" />
            <line x1="7" y1="11" x2="10" y2="8" />
          </svg>
          Distancia
        </button>
        <button class="tool-btn" onclick="activarArea()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"
            style="margin-inline-end: 5px;">
            <path
              d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
            <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
            <line x1="12" y1="22.08" x2="12" y2="12" />
          </svg>
          √Årea
        </button>
        <button class="tool-btn danger" style="grid-column: span 2;" onclick="limpiarMapa()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"
            style="margin-inline-end: 5px;">
            <polyline points="3 6 5 6 21 6" />
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
          </svg>
          Limpiar
        </button>
      </div>
      <div id="measurement-result" style="display:none; margin-block-start:8px; font-weight:600; color:#0f172a;"></div>
    </div>

    <div class="panel-section">
      <h3>Cartograf√≠a Base</h3>
      <div class="layer-item">
        <span>Catastro</span>
        <input type="checkbox" checked id="layer-catastro" onchange="toggleLayer('catastro')">
        <button class="legend-btn" onclick="mostrarLeyenda('catastro')" title="Ver leyenda">üìã</button>
      </div>
      <div class="layer-item">
        <span>Ortofoto</span>
        <input type="checkbox" id="layer-ortofoto" onchange="toggleLayer('ortofoto')">
      </div>
      <div style="margin-block-start:8px;">
        <input type="range" min="0" max="100" value="80" id="opacity-catastro"
          oninput="updateOpacity('catastro', this.value)">
        <div style="font-size:12px; color:#64748b; margin-block-start:6px;">Opacidad: <span
            id="opacity-catastro-val">80%</span></div>
      </div>
    </div>

    <div class="panel-section">
      <h3>Biodiversidad</h3>
      <div class="layer-item">
        <span>Red Natura 2000</span>
        <input type="checkbox" id="layer-red_natura" onchange="toggleLayer('red_natura')">
        <button class="legend-btn" onclick="mostrarLeyenda('red_natura')" title="Ver leyenda">üìã</button>
      </div>
      <div class="layer-item">
        <span>V√≠as Pecuarias</span>
        <input type="checkbox" id="layer-vias_pecuarias" onchange="toggleLayer('vias_pecuarias')">
        <button class="legend-btn" onclick="mostrarLeyenda('vias_pecuarias')" title="Ver leyenda">üìã</button>
      </div>
    </div>
  </div>
  <script>
    function toggleSidebar() {
      const panel = document.querySelector('.side-panel');
      if (!panel) return;
      panel.classList.toggle('collapsed');
      const collapsed = panel.classList.contains('collapsed') ? '1' : '0';
      try { localStorage.setItem('sidebarCollapsed', collapsed); } catch (e) { }
      const btn = document.getElementById('btnToggleSidebar');
      if (btn) { if (collapsed === '1') btn.classList.remove('active'); else btn.classList.add('active'); }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const panel = document.querySelector('.side-panel');
      const btn = document.getElementById('btnToggleSidebar');
      try {
        const state = localStorage.getItem('sidebarCollapsed');
        if (state === '1' && panel) { panel.classList.add('collapsed'); if (btn) btn.classList.remove('active'); }
        else if (panel && btn) { btn.classList.add('active'); }
      } catch (e) { }

      // Inicializar mapa
      initMap();

      // Configurar carga de archivos
      setupFileUpload();

      // Mostrar tab de referencia por defecto
      switchInternalTab('referencia');
    });
  </script>

  <script>
    // Funciones para el panel izquierdo (enlazan con las funciones ya existentes)
    function leftLoadRef() {
      const v = document.getElementById('leftRefInput').value.trim();
      if (!v) return alert('Introduce una referencia');
      // Establecer como referencia activa y cargar
      state.referencias = [v];
      loadSingleReference(v);
    }

    function openRefsTab() {
      // Abrir pesta√±a Referencia para cargas por lote
      switchTab('referencia');
      const ta = document.getElementById('refsTextarea');
      if (ta) ta.focus();
    }
  </script>

  <!-- MAPA -->
  <div id="map"></div>

  <!-- √ÅREA DE CARGA DE ARCHIVOS -->
  <div class="upload-area">
    <input type="file" id="fileInput" class="file-input" multiple accept=".kml,.gml,.geojson,.json,.shp,.zip">
    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
      üìÅ Cargar Archivos
    </button>
    <span class="upload-text">Arrastra archivos KML, GML, GeoJSON o haz clic aqu√≠</span>
    <button class="upload-btn" onclick="cargarReferenciaCatastral()">
      üìç Cargar Referencia
    </button>
  </div>

  <!-- Visor principal: el mapa est√° en el contenedor superior (solo uno) -->
  <!-- El panel lateral derecho ya est√° definido m√°s arriba (class="side-panel") -->

  <!-- PANEL SUPERIOR: TAB 2 REFERENCIA, TAB 3 AN√ÅLISIS, TAB 4 PDF -->
  <div id="panel-superior">

    <!-- TAB 2: REFERENCIA -->
    <div id="tab-referencia" class="tab-content" style="display:none;">
      <div class="panel-section">
        <h3>üìç Cargar Referencia Catastral</h3>
        <div class="refs-input">
          <input id="refInput" type="text" placeholder="Ej: 8884601WF4788S0020LL" />
          <button id="btnLoadRef">Cargar</button>
        </div>
        <label style="font-size:12px; margin-block-end:6px; display:block;">√ì carga m√∫ltiples referencias:</label>
        <textarea id="refsTextarea"
          placeholder="Una referencia por l√≠nea&#10;Ej:&#10;8884601WF4788S0020LL&#10;28045A00100012345UZ"></textarea>
        <button id="btnLoadMultiple" class="action-btn info" style="inline-size:100%; margin-block-start:6px;">Cargar
          Referencias</button>
        <button id="btnLoadFile" class="action-btn success" style="inline-size:100%; margin-block-start:6px;">üìÅ Cargar
          desde Archivo (CSV/TXT)</button>
      </div>

      <div class="panel-section">
        <h3>üó∫Ô∏è Capas Disponibles</h3>
        <div id="capasContainer"
          style="max-block-size:100px; overflow-y:auto; border:1px solid #ddd; border-radius:3px; padding:8px; background:white;">
          <div style="font-size:12px; color:#999;">Cargando capas...</div>
        </div>
        <button id="btnCargarCapasSeleccionadas" class="action-btn"
          style="inline-size:100%; margin-block-start:6px;">Cargar Capas Seleccionadas</button>
      </div>
    </div>

    <!-- TAB 3: AN√ÅLISIS -->
    <div id="tab-analisis" class="tab-content" style="display:none;">
      <div class="panel-section">
        <h3>‚öôÔ∏è Acciones de An√°lisis</h3>
        <div class="buttons-row">
          <button class="action-btn" id="btnUrbanismo">An√°lisis Urban√≠stico</button>
          <button class="action-btn" id="btnAfecciones">An√°lisis Afecciones</button>
          <button class="action-btn" id="btnDescargar">Descargar Datos</button>
          <button class="action-btn error" id="btnLimpiar">Limpiar</button>
        </div>
      </div>

      <!-- Resultados -->
      <div class="panel-section">
        <h3>üìä Resultados</h3>
        <div class="results">
          <div class="result-box">
            <h4>Urban√≠stico</h4>
            <div class="status warning" id="statusUrbanismo">‚Äî</div>
            <div id="msgUrbanismo" style="margin-block-start:4px; font-size:11px; color:#666;"></div>
          </div>
          <div class="result-box">
            <h4>Afecciones</h4>
            <div class="status warning" id="statusAfecciones">‚Äî</div>
            <div id="msgAfecciones" style="margin-block-start:4px; font-size:11px; color:#666;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB 4: PDF MEJORADO -->
    <div id="tab-pdf" class="tab-content" style="display:none;">
      <div class="panel-section">
        <h3>üìÑ Generar Informe Completo</h3>
        <div
          style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-block-end: 15px; border-inline-start: 4px solid #1976d2;">
          <h4 style="color: #1976d2; margin: 0 0 10px 0;">üéØ Selecciona la informaci√≥n a incluir:</h4>

          <div class="checkbox-group" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-block-end: 20px;">
            <label><input type="checkbox" id="pdf-referencia" checked /> üìç Referencia catastral</label>
            <label><input type="checkbox" id="pdf-urbanismo" /> üèôÔ∏è An√°lisis urban√≠stico</label>
            <label><input type="checkbox" id="pdf-afecciones" /> ‚ö†Ô∏è An√°lisis de afecciones</label>
            <label><input type="checkbox" id="pdf-coordenadas" /> üåç Coordenadas</label>
            <label><input type="checkbox" id="pdf-ortofoto" /> üì∑ Ortofoto PNOA</label>
            <label><input type="checkbox" id="pdf-mapa" /> üó∫Ô∏è Mapa con capas</label>
            <label><input type="checkbox" id="pdf-archivos" /> üìÅ Archivos cargados</label>
          </div>

          <div style="margin-block-end: 15px;">
            <label style="font-weight: bold; color: #1976d2;">Formato de salida:</label>
            <select id="pdf-formato"
              style="inline-size: 100%; padding: 8px; border: 1px solid #1976d2; border-radius: 4px; margin-block-start: 5px;">
              <option value="pdf">üìÑ PDF (Recomendado)</option>
              <option value="html">üåê HTML (Interactive)</option>
              <option value="docx">üìù Word Document</option>
            </select>
          </div>

          <button id="btnGenerarPDFCompleto"
            style="inline-size: 100%; padding: 12px; background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%); color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 14px; cursor: pointer;">
            üöÄ GENERAR INFORME COMPLETO
          </button>
        </div>
      </div>

      <div class="panel-section">
        <h3>üìÅ Cargar Archivos para An√°lisis (KML, GML, GeoJSON)</h3>
        <div class="file-upload">
          <div style="margin-block-end: 10px;">
            <label style="font-weight: bold; color: #2b7db3;">üèôÔ∏è Para Urbanismo:</label>
            <input id="fileUrbanismo" type="file" accept=".kml,.gml,.geojson,.json,.gpkg"
              style="inline-size: 100%; margin-block-end: 5px;" />
            <button id="btnCargarUrbanismo" class="action-btn" style="inline-size: 100%;">Cargar para Urbanismo</button>
          </div>

          <div style="margin-block-end: 10px;">
            <label style="font-weight: bold; color: #e74c3c;">‚ö†Ô∏è Para Afecciones:</label>
            <input id="fileAfecciones" type="file" multiple accept=".kml,.gml,.geojson,.json,.gpkg"
              style="inline-size: 100%; margin-block-end: 5px;" />
            <button id="btnCargarAfecciones" class="action-btn" style="inline-size: 100%;">Cargar para
              Afecciones</button>
          </div>

          <div>
            <label style="font-weight: bold; color: #27ae60;">üìÑ Para PDF Completo:</label>
            <input id="filePDF" type="file" multiple accept=".kml,.gml,.geojson,.json,.gpkg"
              style="inline-size: 100%; margin-block-end: 5px;" />
            <button id="btnCargarPDF" class="action-btn" style="inline-size: 100%;">A√±adir al PDF</button>
          </div>

          <div id="fileListComplete"
            style="margin-block-start: 10px; font-size: 11px; color: #666; max-block-size: 120px; overflow: auto;">
          </div>
        </div>
      </div>
    </div>

  </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ===== STATE Y VARIABLES GLOBALES =====
    const state = {
      referencias: [],
      resultsUrbanismo: {},
      resultsAfecciones: {},
      uploadedFiles: new Map(),
      urbanismoFile: null,
      afeccionesFiles: []
    };

    const layers = {
      catastro: null,
      ortofoto: null,
      parcela: null,
      red_natura: null,
      vias_pecuarias: null
    };

    let map = null;
    let layersGroup = null;
    let measurementMode = null;
    let measurementPoints = [];
    let measurementLayer = null;
    let activeVectorLayers = {};

    // ===== CAMBIAR TABS =====
    function switchTab(tab) {
      // Marcar bot√≥n activo (nav-item)
      document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
      const found = Array.from(document.querySelectorAll('.nav-item')).find(b => b.getAttribute('onclick')?.includes(`'${tab}'`));
      if (found) found.classList.add('active');

      // Panel superior contiene las pesta√±as internas (referencia, analisis, pdf)
      const panelSuperior = document.getElementById('panel-superior');
      if (!panelSuperior) return;

      if (tab === 'visor') {
        // Ocultar panel superior y mostrar mapa (map siempre presente)
        panelSuperior.style.display = 'none';
        if (!map) initMap(); else setTimeout(() => map.invalidateSize(), 100);
        return;
      }

      // Mostrar panel superior y la pesta√±a solicitada
      panelSuperior.style.display = 'block';
      // Ocultar todas las pesta√±as internas
      ['referencia', 'analisis', 'pdf'].forEach(name => {
        const el = document.getElementById('tab-' + name);
        if (el) el.style.display = 'none';
      });

      const tabEl = document.getElementById('tab-' + tab);
      if (tabEl) tabEl.style.display = 'block';
    }

    // ===== INICIALIZAR MAPA =====
    function initMap() {
      if (map) {
        map.invalidateSize();
        return;
      }

      map = L.map('map').setView([40.0, -3.7], 6);
      layersGroup = L.layerGroup().addTo(map);
      measurementLayer = L.layerGroup().addTo(map);

      // Agregar capas base
      addBaseLayers();

      // Event listeners para mediciones
      map.on('click', handleMapClick);
      map.on('dblclick', handleMapDblClick);

      console.log('‚úÖ Mapa inicializado');
    }

    function addBaseLayers() {
      // OSM
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap',
        maxZoom: 19
      }).addTo(map);

      // Catastro WMS
      layers.catastro = L.tileLayer.wms(
        'https://ovc.catastro.meh.es/cartografia/INSPIRE/spadgcwms.aspx',
        { layers: 'CP.CadastralParcel', format: 'image/png', transparent: true, opacity: 0.8 }
      ).addTo(map);

      // PNOA Ortofoto
      layers.ortofoto = L.tileLayer.wms(
        'https://www.ign.es/wms-inspire/pnoa-ma',
        { layers: 'OI.OrthoimageCoverage', format: 'image/png', transparent: true, opacity: 0.7 }
      ).addTo(map);

      // Biodiversidad - Red Natura 2000
      layers.red_natura = L.tileLayer.wms(
        'https://wms.mapama.gob.es/sig/Biodiversidad/RedNatura/wms.aspx',
        { layers: 'PS.ProtectedSite', format: 'image/png', transparent: true, opacity: 0.6 }
      );

      // Biodiversidad - V√≠as Pecuarias
      layers.vias_pecuarias = L.tileLayer.wms(
        'https://wms.mapama.gob.es/sig/Biodiversidad/ViasPecuarias/wms.aspx',
        { layers: 'Vias_Pecuarias', format: 'image/png', transparent: true, opacity: 0.6 }
      );
    }

    // ===== GESTI√ìN DE CAPAS =====
    function toggleLayer(layerName) {
      const checkbox = document.getElementById(`layer-${layerName}`);
      const layer = layers[layerName];

      if (!layer) return;

      if (checkbox.checked) {
        map.addLayer(layer);
      } else {
        map.removeLayer(layer);
      }
    }

    function updateOpacity(layerName, opacity) {
      const layer = layers[layerName];
      if (layer && layer.setOpacity) {
        layer.setOpacity(opacity / 100);
      }
      const display = document.getElementById(`opacity-${layerName}-val`) || document.getElementById(`opacity-${layerName}-value`) || document.getElementById(`opacity-${layerName}`);
      if (display) display.textContent = opacity + '%';
    }

    // ===== MEDICIONES =====
    function toggleMeasureDistance() {
      if (measurementMode === 'distance') {
        measurementMode = null;
        measurementPoints = [];
        document.querySelectorAll('.tool-btn')[0].classList.remove('active');
      } else {
        measurementMode = 'distance';
        measurementPoints = [];
        clearMeasurements();
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tool-btn')[0].classList.add('active');
        alert('üìè Haz clic para marcar puntos. Doble clic para terminar.');
      }
    }

    function toggleMeasureArea() {
      if (measurementMode === 'area') {
        measurementMode = null;
        measurementPoints = [];
        document.querySelectorAll('.tool-btn')[1].classList.remove('active');
      } else {
        measurementMode = 'area';
        measurementPoints = [];
        clearMeasurements();
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tool-btn')[1].classList.add('active');
        alert('üìê Haz clic para marcar v√©rtices. Doble clic para cerrar.');
      }
    }

    function handleMapClick(e) {
      if (!measurementMode) return;

      const pt = e.latlng;
      measurementPoints.push([pt.lat, pt.lng]);

      // Marcador
      L.circleMarker(pt, { radius: 5, color: '#fff', weight: 2, fillColor: '#2b7db3', fillOpacity: 1 }).addTo(measurementLayer);

      if (measurementPoints.length >= 2) {
        const prev = measurementPoints[measurementPoints.length - 2];
        const dist = map.distance(prev, [pt.lat, pt.lng]);

        L.polyline([prev, [pt.lat, pt.lng]], { color: '#2b7db3', weight: 2, dashArray: '5,5' }).addTo(measurementLayer);

        if (measurementMode === 'distance') {
          const total = measurementPoints.reduce((sum, p, i) => {
            if (i === 0) return 0;
            return sum + map.distance(measurementPoints[i - 1], p);
          }, 0);

          // Formatear distancia
          let distanceText;
          if (total < 1000) {
            distanceText = `üìè Distancia: ${total.toFixed(1)} m`;
          } else {
            distanceText = `üìè Distancia: ${(total / 1000).toFixed(2)} km`;
          }
          showMeasurement(distanceText);

        } else if (measurementMode === 'area' && measurementPoints.length >= 3) {
          // Crear pol√≠gono temporal para mostrar √°rea
          if (window.tempShape) {
            measurementLayer.removeLayer(window.tempShape);
          }

          window.tempShape = L.polygon(measurementPoints, {
            color: '#10b981',
            fillColor: '#10b981',
            fillOpacity: 0.3,
            weight: 3
          }).addTo(measurementLayer);

          const area = calcArea(measurementPoints);
          const areaText = `üìê √Årea: ${formatArea(area)}`;
          showMeasurement(areaText);

          // Mostrar tooltip en el centro del pol√≠gono
          const center = measurementPoints.reduce((acc, point) => ({
            lat: acc.lat + point[0] / measurementPoints.length,
            lng: acc.lng + point[1] / measurementPoints.length
          }), { lat: 0, lng: 0 });

          if (window.areaTooltip) {
            map.removeLayer(window.areaTooltip);
          }

          window.areaTooltip = L.marker(center, {
            icon: L.divIcon({
              className: 'area-tooltip',
              html: `<div style="background: rgba(16, 185, 129, 0.9); color: white; padding: 6px 12px; border-radius: 6px; font-size: 14px; font-weight: bold; white-space: nowrap; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${areaText}</div>`,
              iconSize: [150, 30],
              iconAnchor: [75, 15]
            })
          }).addTo(map);
        }
      }
    }

    function handleMapDblClick(e) {
      if (!measurementMode) return;
      measurementMode = null;
      document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    }

    function calcArea(points) {
      // Usar el m√©todo m√°s preciso con L.GeometryUtil si est√° disponible
      if (window.L && window.L.GeometryUtil) {
        const area = L.GeometryUtil.geodesicArea(points);
        return area; // ya est√° en metros cuadrados
      }

      // M√©todo alternativo: f√≥rmula de Shoelace con conversi√≥n a metros
      const latToM = 111320; // metros por grado de latitud
      const avgLat = points.reduce((s, p) => s + p[0], 0) / points.length;
      const lngToM = latToM * Math.cos(avgLat * Math.PI / 180);

      let area = 0;
      for (let i = 0; i < points.length; i++) {
        const j = (i + 1) % points.length;
        const xi = points[i][1] * lngToM;
        const yi = points[i][0] * latToM;
        const xj = points[j][1] * lngToM;
        const yj = points[j][0] * latToM;
        area += xi * yj - xj * yi;
      }
      return Math.abs(area / 2);
    }

    function formatArea(area) {
      // Formatear el √°rea para mejor legibilidad
      if (area < 1000) {
        return `${area.toFixed(1)} m¬≤`;
      } else if (area < 10000) {
        return `${(area / 1000).toFixed(2)} mil m¬≤`;
      } else if (area < 1000000) {
        return `${(area / 10000).toFixed(2)} ha`;
      } else {
        return `${(area / 1000000).toFixed(2)} km¬≤`;
      }
    }

    function showMeasurement(text) {
      const el = document.getElementById('measurement-result');
      el.textContent = text;
      el.classList.add('active');
    }

    function clearMeasurements() {
      measurementLayer.clearLayers();
      measurementPoints = [];
      measurementMode = null;
      document.getElementById('measurement-result').classList.remove('active');
      document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));

      // Limpiar elementos de medici√≥n temporales
      if (window.tempShape) {
        measurementLayer.removeLayer(window.tempShape);
        window.tempShape = null;
      }

      if (window.areaTooltip) {
        map.removeLayer(window.areaTooltip);
        window.areaTooltip = null;
      }
    }

    function limpiarMapa() {
      // Limpiar mediciones
      drawingLayer.clearLayers();

      // Limpiar capas cargadas
      if (window.loadedLayers && window.loadedLayers.length > 0) {
        window.loadedLayers.forEach(layer => {
          map.removeLayer(layer);
        });
        window.loadedLayers = [];
      }

      // Resetear mediciones
      measurementMode = null;
      if (map) {
        map.off('click', onMapClickDistancia);
        map.off('click', onMapClickArea);
      }

      // Limpiar tooltips
      document.querySelectorAll('.measurement-tooltip').forEach(el => el.remove());

      // Resetear botones
      document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Limpiar input de archivos
      const fileInput = document.getElementById('fileInput');
      if (fileInput) {
        fileInput.value = '';
      }

      console.log('Mapa limpiado: mediciones y capas cargadas eliminadas');
    }

    // ===== CAPAS =====
    async function loadCapasDisponibles() {
      try {
        const res = await fetch('/api/v1/capas-disponibles');
        const data = await res.json();
        const capas = data.capas?.capas_vectoriales || [];
        const container = document.getElementById('capasContainer');
        container.innerHTML = '';

        if (capas.length === 0) {
          container.innerHTML = '<div style="font-size:12px; color:#999;">No hay capas disponibles</div>';
          return;
        }

        capas.forEach(capa => {
          const div = document.createElement('div');
          div.style.marginBottom = '6px';
          const id = 'chk_capa_' + capa.nombre.replace(/\W/g, '_');
          div.innerHTML = `<input type="checkbox" id="${id}" data-capa="${capa.nombre}" data-ruta="${capa.ruta}" /> <label for="${id}" style="display:inline; margin:0; font-size:11px; cursor:pointer;">${capa.nombre}</label>`;
          container.appendChild(div);
        });
      } catch (e) { console.error('Error:', e); }
    }

    document.getElementById('btnCargarCapasSeleccionadas').onclick = async () => {
      const checkboxes = document.querySelectorAll('#capasContainer input[type="checkbox"]:checked');
      if (checkboxes.length === 0) return alert('Selecciona capas');

      for (const checkbox of checkboxes) {
        const nombre = checkbox.dataset.capa;
        const ruta = checkbox.dataset.ruta;

        try {
          const g = await fetch(`/api/v1/capas/geojson?ruta=${encodeURIComponent(ruta)}`);
          const geojson = await g.json();

          const layer = L.geoJSON(geojson, {
            style: { color: '#ff7800', weight: 1, fillOpacity: 0.4 },
            onEachFeature: (f, l) => f.properties && l.bindPopup(JSON.stringify(f.properties))
          });
          activeVectorLayers[nombre] = layer;
          layersGroup.addLayer(layer);

          if (layer.getBounds) map.fitBounds(layer.getBounds());
        } catch (e) { console.error('Error:', nombre, e); }
      }
    };

    // MOVIDO: loadCapasDisponibles ahora se llama desde DOMContentLoaded para evitar carga prematura\r\n    // loadCapasDisponibles();

    // ===== REFERENCIAS =====
    document.getElementById('btnLoadRef').onclick = async () => {
      const ref = document.getElementById('refInput').value.trim();
      if (!ref) return alert('Introduce una referencia');
      await loadSingleReference(ref);
    };

    document.getElementById('btnLoadMultiple').onclick = async () => {
      const text = document.getElementById('refsTextarea').value.trim();
      if (!text) return alert('Introduce referencias');
      const refs = text.split(/[\n,]+/).map(r => r.trim()).filter(r => r);
      state.referencias = refs;
      alert(`Cargadas ${refs.length} referencias`);
    };

    async function loadSingleReference(ref, callback) {
      try {
        console.log(`üîç Cargando referencia: ${ref}`);

        // Primero obtener coordenadas de la referencia
        const coordsResponse = await fetch(`/api/v1/referencia/${encodeURIComponent(ref)}/geojson`);
        if (!coordsResponse.ok) {
          alert(`‚ùå Referencia no encontrada: ${ref}`);
          return;
        }

        const coordsData = await coordsResponse.json();
        console.log('üìç Coordenadas obtenidas:', coordsData);

        // Remover parcela anterior si existe
        if (layers.parcela) {
          map.removeLayer(layers.parcela);
          layers.parcela = null;
        }

        // Crear capa de parcela con las coordenadas (acepta FeatureCollection con Polygon o Point)
        if (coordsData && coordsData.type === 'FeatureCollection' && Array.isArray(coordsData.features) && coordsData.features.length > 0) {
          const feat = coordsData.features[0];
          if (feat.geometry && (feat.geometry.type === 'Polygon' || feat.geometry.type === 'MultiPolygon')) {
            // Dibujar pol√≠gono de parcela en rojo
            const parcelaLayer = L.geoJSON(feat, {
              style: { color: '#ef4444', weight: 3, fillOpacity: 0.06 }
            }).addTo(map);
            layers.parcela = parcelaLayer;
            try {
              const latlngs = [];
              if (feat.geometry.type === 'Polygon') latlngs.push(feat.geometry.coordinates[0].map(c => [c[1], c[0]]));
              else if (feat.geometry.type === 'MultiPolygon') latlngs.push(...feat.geometry.coordinates[0].map(r => r.map(c => [c[1], c[0]])));
              // Ajustar vista
              if (parcelaLayer.getBounds) map.fitBounds(parcelaLayer.getBounds());
              // Calcular √°rea si L.GeometryUtil est√° disponible
              let areaText = '';
              try {
                const flat = (feat.geometry.type === 'Polygon') ? feat.geometry.coordinates[0].map(c => L.latLng(c[1], c[0])) : feat.geometry.coordinates[0][0].map(c => L.latLng(c[1], c[0]));
                const area = (window.L && window.L.GeometryUtil) ? L.GeometryUtil.geodesicArea(flat) : 0;
                if (area) areaText = `üìê √Årea: ${formatArea(area)}`;
              } catch (err) { console.warn(err); }
              if (areaText) {
                const measEl = document.getElementById('measurement-result');
                if (measEl) { measEl.textContent = areaText; measEl.style.display = 'block'; }
                alert(`‚úÖ Parcela cargada: ${ref}\n${areaText}`);
              } else {
                alert(`‚úÖ Parcela cargada: ${ref}`);
              }
              if (callback) callback(true);
            } catch (err) {
              console.error(err);
              if (callback) callback(false);
            }
          } else if (feat.geometry && feat.geometry.type === 'Point') {
            const [lon, lat] = feat.geometry.coordinates;
            const marker = L.marker([lat, lon], { title: `Referencia: ${ref}` }).addTo(map);
            const circle = L.circle([lat, lon], { color: 'red', fillColor: '#f03', fillOpacity: 0.2, radius: 50 }).addTo(map);
            const parcelaLayer = L.layerGroup([marker, circle]);
            layers.parcela = parcelaLayer;
            map.setView([lat, lon], 18);
            alert(`‚úÖ Referencia catastral cargada:\n${ref}\n\nCoordenadas: ${lat.toFixed(6)}, ${lon.toFixed(6)}`);
            if (callback) callback(true);
          } else {
            alert(`‚ùå Geometr√≠a no reconocida para referencia: ${ref}`);
            if (callback) callback(false);
          }

        } else if (coordsData && coordsData.type === 'Point') {
          const [lon, lat] = coordsData.coordinates;

          // Crear marcador para la parcela
          const marker = L.marker([lat, lon], {
            title: `Referencia: ${ref}`
          }).addTo(map);

          // Crear c√≠rculo para visualizar el √°rea
          const circle = L.circle([lat, lon], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.2,
            radius: 50 // metros
          }).addTo(map);

          // Combinar marcador y c√≠rculo en una capa
          const parcelaLayer = L.layerGroup([marker, circle]);
          layers.parcela = parcelaLayer;

          // Centrar el mapa en la referencia
          map.setView([lat, lon], 18);

          // Actualizar estado
          if (!state.referencias.includes(ref)) {
            state.referencias.push(ref);
          }

          console.log(`‚úÖ Referencia ${ref} cargada correctamente`);
          alert(`‚úÖ Referencia catastral cargada:\n${ref}\n\nCoordenadas: ${lat.toFixed(6)}, ${lon.toFixed(6)}`);

          // Llamar callback si existe
          if (callback) callback(true);

        } else {
          alert(`‚ùå Formato de coordenadas inv√°lido para referencia: ${ref}`);
          if (callback) callback(false);
        }

      } catch (e) {
        console.error('‚ùå Error cargando referencia:', e);
        alert(`‚ùå Error cargando referencia: ${e.message}`);
        if (callback) callback(false);
      }
    };

    // ===== CARGAR M√öLTIPLES REFERENCIAS DESDE ARCHIVO =====
    document.getElementById('btnLoadFile').onclick = () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.txt,.csv';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const text = await file.text();
        const refs = text.split(/[\n,]+/)
          .map(r => r.trim())
          .filter(r => r && r.match(/^\d+[A-Z]\d+$/)); // Formato de referencia catastral

        if (refs.length === 0) {
          alert('‚ùå No se encontraron referencias v√°lidas en el archivo');
          return;
        }

        state.referencias = [...state.referencias, ...refs];
        alert(`‚úÖ Se cargaron ${refs.length} referencias desde el archivo:\n${refs.slice(0, 5).join('\n')}${refs.length > 5 ? '\n...' : ''}`);

        // Cargar cada referencia
        for (const ref of refs) {
          await loadSingleReference(ref);
        }
      };
      input.click();
    };

    // ===== AN√ÅLISIS =====
    // 1. Consultar Referencia (nuevo endpoint referenciaspy)
    async function consultarReferencia() {
      if (state.referencias.length === 0) return alert('Carga una referencia primero');

      const ref = state.referencias[0]; // Usar primera referencia
      const statusEl = document.getElementById('statusUrbanismo');
      const msgEl = document.getElementById('msgUrbanismo');
      statusEl.textContent = '‚è≥ Consultando...';
      statusEl.className = 'status warning';

      try {
        const res = await fetch(`/api/v1/consultar-referencia/${encodeURIComponent(ref)}`);
        const data = await res.json();

        if (data.success) {
          statusEl.textContent = '‚úì Consultada';
          statusEl.className = 'status success';
          msgEl.innerHTML = `Referencia ${ref} consultada correctamente.`;
          state.resultsUrbanismo = [data];
        } else {
          statusEl.textContent = '‚úó No encontrada';
          statusEl.className = 'status error';
          msgEl.innerHTML = data.error || 'Referencia no encontrada';
        }
      } catch (e) {
        statusEl.textContent = '‚úó Error';
        statusEl.className = 'status error';
        msgEl.innerHTML = e.message;
      }
    }

    document.getElementById('btnUrbanismo').onclick = async () => {
      if (state.referencias.length === 0) return alert('Carga una referencia primero');

      const statusEl = document.getElementById('statusUrbanismo');
      const msgEl = document.getElementById('msgUrbanismo');
      statusEl.textContent = '‚è≥ Procesando...';
      statusEl.className = 'status warning';

      try {
        const promises = state.referencias.map(ref =>
          fetch('/api/v1/analizar-urbanismo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ referencia: ref })
          }).then(r => r.json())
        );
        const results = await Promise.all(promises);
        const successful = results.filter(r => r.status === 'success').length;
        state.resultsUrbanismo = results;

        statusEl.textContent = `‚úì ${successful}/${state.referencias.length}`;
        statusEl.className = 'status success';
        msgEl.innerHTML = `${successful} referencias procesadas.`;
      } catch (e) {
        statusEl.textContent = '‚úó Error';
        statusEl.className = 'status error';
        msgEl.innerHTML = e.message;
      }
    };

    // 2. An√°lisis de Intersecciones (nuevo endpoint referenciaspy - IntersectionService)
    document.getElementById('btnAfecciones').onclick = async () => {
      if (state.referencias.length === 0) return alert('Carga una referencia primero');

      const statusEl = document.getElementById('statusAfecciones');
      const msgEl = document.getElementById('msgAfecciones');
      statusEl.textContent = '‚è≥ Analizando intersecciones...';
      statusEl.className = 'status warning';

      try {
        const promises = state.referencias.map(ref =>
          fetch('/api/v1/analizar-afecciones', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ referencia: ref })
          }).then(r => r.json())
        );
        const results = await Promise.all(promises);
        const successful = results.filter(r => r.status === 'success').length;
        state.resultsAfecciones = results;

        // Contar afecciones totales
        let totalAfecciones = 0;
        results.forEach(r => {
          if (r.afecciones) totalAfecciones += r.afecciones.length;
        });

        statusEl.textContent = `‚úì ${successful}/${state.referencias.length}`;
        statusEl.className = 'status success';
        msgEl.innerHTML = `${successful} referencias analizadas. ${totalAfecciones} capas afectadas.`;
      } catch (e) {
        statusEl.textContent = '‚úó Error';
        statusEl.className = 'status error';
        msgEl.innerHTML = e.message;
      }
    };

    document.getElementById('btnDescargar').onclick = async () => {
      if (state.referencias.length === 0) return alert('Carga una referencia primero');

      for (const ref of state.referencias) {
        try {
          const g = await fetch(`/api/v1/referencia/${encodeURIComponent(ref)}/geojson`).then(r => r.json());
          const dataStr = JSON.stringify(g, null, 2);
          const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

          const a = document.createElement('a');
          a.href = dataUri;
          a.download = `${ref}.geojson`;
          a.click();
        } catch (e) { console.error('Error descargando:', e); }
      }
    };

    document.getElementById('btnLimpiar').onclick = () => {
      state.referencias = [];
      measurementPoints = [];
      measurementMode = null;
      if (layersGroup) layersGroup.clearLayers();
      if (measurementLayer) measurementLayer.clearLayers();
      document.getElementById('statusUrbanismo').textContent = '‚Äî';
      document.getElementById('statusAfecciones').textContent = '‚Äî';
      document.getElementById('msgUrbanismo').innerHTML = '';
      document.getElementById('msgAfecciones').innerHTML = '';
      alert('Limpiado');
    };

    // ===== FUNCIONES PDF COMPLETO =====
    document.getElementById('btnGenerarPDFCompleto').onclick = async () => {
      try {
        // Obtener opciones seleccionadas
        const opciones = {
          referencia: state.referencias.length > 0 ? state.referencias[0] : null,
          incluir_referencia: document.getElementById('pdf-referencia').checked,
          incluir_urbanismo: document.getElementById('pdf-urbanismo').checked,
          incluir_afecciones: document.getElementById('pdf-afecciones').checked,
          incluir_coordenadas: document.getElementById('pdf-coordenadas').checked,
          incluir_ortofoto: document.getElementById('pdf-ortofoto').checked,
          incluir_mapa: document.getElementById('pdf-mapa').checked,
          incluir_capas_cargadas: document.getElementById('pdf-archivos').checked,
          archivos_adicionales: Array.from(state.uploadedFiles.entries()).map(([name, file]) => ({
            nombre: name,
            tipo: file.tipo,
            contenido: file.contenido
          })),
          formato: document.getElementById('pdf-formato').value
        };

        // Validar que haya algo para generar
        if (!opciones.referencia && !opciones.incluir_capas_cargadas) {
          alert('‚ö†Ô∏è Debes especificar una referencia catastral o cargar archivos');
          return;
        }

        // Mostrar progreso
        const btn = document.getElementById('btnGenerarPDFCompleto');
        const originalText = btn.textContent;
        btn.textContent = '‚è≥ Generando informe...';
        btn.disabled = true;

        const res = await fetch('/api/v1/generar-pdf-completo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(opciones)
        });

        const data = await res.json();

        // Restaurar bot√≥n
        btn.textContent = originalText;
        btn.disabled = false;

        if (data.status === 'success' || data.status === 'warning') {
          const mensaje = `
üéâ Informe generado exitosamente!
üìÑ Formato: ${data.formato.toUpperCase()}
üìä Secciones: ${data.secciones_generadas}
üìÅ Ubicaci√≥n: ${data.output}
${data.message ? `‚ÑπÔ∏è ${data.message}` : ''}`;

          alert(mensaje);

          // Descargar autom√°ticamente si es exitoso
          if (data.status === 'success') {
            window.open(data.output, '_blank');
          }
        } else {
          alert(`‚ùå Error generando informe: ${data.error || 'Error desconocido'}`);
        }
      } catch (e) {
        const btn = document.getElementById('btnGenerarPDFCompleto');
        btn.textContent = 'üöÄ GENERAR INFORME COMPLETO';
        btn.disabled = false;
        alert(`‚ùå Error: ${e.message}`);
      }
    };

    // ===== FUNCIONES PARA ARCHIVOS =====
    document.getElementById('btnCargarUrbanismo').onclick = async () => {
      const fileInput = document.getElementById('fileUrbanismo');
      if (fileInput.files.length === 0) {
        alert('‚ö†Ô∏è Selecciona un archivo para an√°lisis urban√≠stico');
        return;
      }

      const file = fileInput.files[0];
      const contenido = await readFileAsBase64(file);

      // Actualizar estado
      state.urbanismoFile = {
        nombre: file.name,
        tipo: file.name.split('.').pop().toLowerCase(),
        contenido: contenido
      };

      alert(`‚úÖ Archivo urban√≠stico cargado: ${file.name}`);
    };

    document.getElementById('btnCargarAfecciones').onclick = async () => {
      const fileInput = document.getElementById('fileAfecciones');
      if (fileInput.files.length === 0) {
        alert('‚ö†Ô∏è Selecciona archivos para an√°lisis de afecciones');
        return;
      }

      const archivos = [];
      for (let file of fileInput.files) {
        const contenido = await readFileAsBase64(file);
        archivos.push({
          nombre: file.name,
          tipo: file.name.split('.').pop().toLowerCase(),
          contenido: contenido
        });
      }

      // Actualizar estado
      state.afeccionesFiles = archivos;

      alert(`‚úÖ ${archivos.length} archivos cargados para an√°lisis de afecciones`);
    };

    document.getElementById('btnCargarPDF').onclick = async () => {
      const fileInput = document.getElementById('filePDF');
      if (fileInput.files.length === 0) {
        alert('‚ö†Ô∏è Selecciona archivos para incluir en el PDF');
        return;
      }

      for (let file of fileInput.files) {
        const contenido = await readFileAsBase64(file);
        state.uploadedFiles.set(file.name, {
          tipo: file.name.split('.').pop().toLowerCase(),
          contenido: contenido
        });
      }

      updateFileListComplete();
      alert(`‚úÖ ${fileInput.files.length} archivos a√±adidos al informe PDF`);
    };

    // Funci√≥n auxiliar para leer archivos como base64
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Actualizar lista de archivos completos
    function updateFileListComplete() {
      const fileList = document.getElementById('fileListComplete');
      const files = Array.from(state.uploadedFiles.entries());

      if (files.length === 0) {
        fileList.innerHTML = '<div style="color: #999;">No hay archivos cargados</div>';
        return;
      }

      let html = '<div style="font-weight: bold; margin-block-end: 8px;">üìÅ Archivos para incluir en PDF:</div>';
      files.forEach(([name, file], index) => {
        html += `
          <div class="file-item">
            <span>üìÑ ${name} (${file.tipo.toUpperCase()})</span>
            <button onclick="removePDFFile('${name}')">‚úï</button>
          </div>
        `;
      });

      fileList.innerHTML = html;
    }

    // Eliminar archivo de la lista
    function removePDFFile(name) {
      state.uploadedFiles.delete(name);
      updateFileListComplete();
    }

    // Reemplazar funci√≥n antigua de generar PDF (si existe el bot√≥n antiguo)
    const oldBtnGen = document.getElementById('btnGenerarPDF');
    if (oldBtnGen) {
      oldBtnGen.onclick = async () => {
        alert('‚ÑπÔ∏è Esta funci√≥n ha sido reemplazada por "Generar Informe Completo" en la pesta√±a PDF');
      };
    }

    const oldBtnLoadFiles = document.getElementById('btnLoadFiles');
    if (oldBtnLoadFiles) {
      oldBtnLoadFiles.onclick = () => {
        alert('‚ÑπÔ∏è Esta funci√≥n ha sido reemplazada por las opciones espec√≠ficas en la pesta√±a PDF');
      };
    }

    // Variables globales para la medici√≥n
    let drawingLayer = new L.FeatureGroup();
    let points = [];
    let tempLine, tempShape;

    function limpiarMapa() {
      if (drawingLayer) {
        drawingLayer.clearLayers();
      }
      points = [];
      map.off('click', onMapClickDistancia);
      map.off('click', onMapClickArea);
      map.off('mousemove', onMouseMove);
    }

    // --- FUNCI√ìN PARA MEDIR DISTANCIA ---
    function activarDistancia() {
      limpiarMapa();
      if (!map.hasLayer(drawingLayer)) {
        drawingLayer.addTo(map);
      }

      // Crear tooltip de instrucci√≥n
      const instructionTooltip = L.tooltip({
        permanent: true,
        direction: 'top',
        className: 'measurement-tooltip'
      }).setLatLng(map.getCenter()).setContent('üìè Haz clic para medir distancias. Doble clic para terminar.').addTo(map);

      setTimeout(() => {
        map.removeLayer(instructionTooltip);
      }, 3000);

      map.on('click', onMapClickDistancia);
    }

    function onMapClickDistancia(e) {
      points.push(e.latlng);

      if (points.length > 1) {
        let dist = 0;
        for (let i = 0; i < points.length - 1; i++) {
          dist += points[i].distanceTo(points[i + 1]);
        }

        const polyline = L.polyline(points, {
          color: '#3b82f6',
          weight: 4,
          opacity: 0.8
        }).addTo(drawingLayer);

        polyline.bindTooltip((dist / 1000).toFixed(2) + " km", {
          permanent: true,
          direction: 'center',
          className: 'measurement-tooltip-distance'
        }).openTooltip();
      }

      L.circleMarker(e.latlng, {
        radius: 5,
        color: '#3b82f6',
        fillColor: '#3b82f6',
        fillOpacity: 1
      }).addTo(drawingLayer);
    }

    // --- FUNCI√ìN PARA MANEJO DE ARCHIVOS ---
    function setupFileUpload() {
      const fileInput = document.getElementById('file-input');
      const fileList = document.getElementById('file-list');
      const refsFileInput = document.getElementById('refs-file-input');
      const refsFileList = document.getElementById('refs-file-list');

      // Archivos geogr√°ficos (KML, GML, GeoJSON)
      fileInput.addEventListener('change', function (e) {
        const files = e.target.files;
        if (files.length > 0) {
          fileList.innerHTML = `<strong>Archivos seleccionados:</strong><br>`;
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            fileList.innerHTML += `üìÑ ${file.name} (${(file.size / 1024).toFixed(1)}KB)<br>`;
          }
          // Procesar archivos
          handleFiles(files);
        }
      });

      // Archivo de referencias (TXT/CSV)
      refsFileInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
          refsFileList.innerHTML = `üìÑ ${file.name} (${(file.size / 1024).toFixed(1)}KB)<br>`;
          // Procesar archivo de referencias
          handleRefsFile(file);
        }
      });
    }

    function handleRefsFile(file) {
      const reader = new FileReader();

      reader.onload = function (e) {
        try {
          const content = e.target.result;
          const extension = file.name.split('.').pop().toLowerCase();

          let referencias = [];

          if (extension === 'csv') {
            // Procesar CSV
            const lines = content.split('\n').filter(line => line.trim());
            // Asumir primera columna como referencia
            referencias = lines.map(line => {
              const cols = line.split(',');
              return cols[0].trim().replace(/["']/g, ''); // Quitar comillas
            }).filter(ref => ref.length > 0);
          } else if (extension === 'txt') {
            // Procesar TXT (una referencia por l√≠nea)
            referencias = content.split('\n')
              .map(line => line.trim())
              .filter(line => line.length > 0);
          }

          // Mostrar resultados
          const refsFileList = document.getElementById('refs-file-list');
          refsFileList.innerHTML = `<strong>üìã ${referencias.length} referencias encontradas:</strong><br>`;

          // Mostrar primeras 5 como preview
          const preview = referencias.slice(0, 5).join('<br>');
          refsFileList.innerHTML += preview;

          if (referencias.length > 5) {
            refsFileList.innerHTML += `<br>... y ${referencias.length - 5} m√°s`;
          }

          // Bot√≥n para cargar todas
          refsFileList.innerHTML += `<br><br><button class="upload-btn" style="font-size:12px; padding:6px 12px;" onclick="cargarLoteReferencias(${JSON.stringify(referencias)})">üöÄ Cargar todas las referencias</button>`;

          // Guardar referencias en state
          state.loteReferencias = referencias;

        } catch (error) {
          console.error('Error procesando archivo de referencias:', error);
          const refsFileList = document.getElementById('refs-file-list');
          refsFileList.innerHTML = `‚ùå Error al procesar el archivo: ${error.message}`;
        }
      };

      reader.readAsText(file);
    }

    function cargarLoteReferencias(referencias) {
      if (!referencias || referencias.length === 0) {
        alert('No hay referencias para cargar');
        return;
      }

      const refsFileList = document.getElementById('refs-file-list');
      refsFileList.innerHTML = `‚è≥ Cargando ${referencias.length} referencias...`;

      // Mostrar tab de referencia
      switchInternalTab('referencia');

      // Cargar referencias en lotes de 10 para no sobrecargar
      let cargadas = 0;
      let errores = 0;

      function cargarSiguiente() {
        if (cargadas < referencias.length) {
          const ref = referencias[cargadas];
          loadSingleReference(ref, function (success) {
            if (success) {
              cargadas++;
            } else {
              errores++;
            }

            // Actualizar progreso
            const progress = Math.round((cargadas + errores) / referencias.length * 100);
            refsFileList.innerHTML = `‚è≥ Progreso: ${progress}% (${cargadas + errores}/${referencias.length})<br>‚úÖ Cargadas: ${cargadas} | ‚ùå Errores: ${errores}`;

            // Siguiente referencia
            setTimeout(cargarSiguiente, 100); // Peque√±a pausa para no sobrecargar
          });
        } else {
          // Finalizado
          refsFileList.innerHTML = `üéâ ¬°Completado!<br>‚úÖ Cargadas: ${cargadas}<br>‚ùå Errores: ${errores}<br><small>Revisa el mapa y el panel de resultados</small>`;
        }
      }

      // Iniciar carga
      cargarSiguiente();
    }

    function handleFiles(files) {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();

        reader.onload = function (e) {
          try {
            const content = e.target.result;
            const extension = file.name.split('.').pop().toLowerCase();

            // Procesar seg√∫n el tipo de archivo
            if (extension === 'geojson' || extension === 'json') {
              const geojson = JSON.parse(content);
              L.geoJSON(geojson, {
                style: {
                  color: '#ef4444',
                  weight: 2,
                  fillOpacity: 0.3
                }
              }).addTo(map);
              map.fitBounds(L.geoJSON(geojson).getBounds());
            } else if (extension === 'kml') {
              // Convertir KML a GeoJSON (simplificado)
              console.log('KML file detected - conversion needed');
            } else if (extension === 'gml') {
              // Convertir GML a GeoJSON (simplificado)
              console.log('GML file detected - conversion needed');
            }
          } catch (error) {
            console.error('Error processing file:', error);
          }
        };

        reader.readAsText(file);
      }
    }

    // --- FUNCIONES DE AN√ÅLISIS URBAN√çSTICO Y AFECIONES ---
    
    // Funciones para Urbanismo
    async function analizarUrbanismoDesdeRef() {
      const ref = document.getElementById('urbanismoRefInput').value.trim();
      if (!ref) {
        alert('‚ö†Ô∏è Por favor, introduce una referencia catastral');
        return;
      }
      
      const resultDiv = document.getElementById('urbanismoResult');
      resultDiv.innerHTML = '‚è≥ Analizando urbanismo...';
      
      try {
        const res = await fetch('/api/v1/analizar-urbanismo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ referencia: ref })
        });
        
        const data = await res.json();
        if (data.status === 'success') {
          const u = data.data.analisis_urbanistico;
          resultDiv.innerHTML = `
            <div style="background: #e8f5e9; padding: 10px; border-radius: 4px; color: #333;">
              <strong>‚úÖ An√°lisis completado</strong><br>
              <strong>Suelo:</strong> ${u.suelo}<br>
              <strong>Edificabilidad:</strong> ${u.edificabilidad}<br>
              <strong>Superficie parcela:</strong> ${u.superficie_parcela}<br>
              <strong>Ocupaci√≥n:</strong> ${u.ocupacion_estimada}
            </div>
          `;
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Error: ${data.message}</div>`;
        }
      } catch (e) {
        resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Error de conexi√≥n: ${e.message}</div>`;
      }
    }
    
    async function analizarUrbanismoDesdeArchivo() {
      const fileInput = document.getElementById('fileUrbanismo');
      const resultDiv = document.getElementById('urbanismoResult');
      
      if (fileInput.files.length === 0) {
        alert('‚ö†Ô∏è Por favor, selecciona un archivo vectorial');
        return;
      }
      
      resultDiv.innerHTML = '‚è≥ Procesando archivo...';
      
      try {
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);
        
        const res = await fetch('/api/v1/analizar-urbanismo-archivo', {
          method: 'POST',
          body: formData
        });
        
        const data = await res.json();
        if (data.status === 'success') {
          resultDiv.innerHTML = `
            <div style="background: #e8f5e9; padding: 10px; border-radius: 4px; color: #333;">
              <strong>‚úÖ An√°lisis completado desde archivo</strong><br>
              <strong>Archivo:</strong> ${file.name}<br>
              <strong>Geometr√≠as procesadas:</strong> ${data.data.geometrias || 1}<br>
              <strong>Resultado:</strong> ${data.data.resultado || 'Procesado correctamente'}
            </div>
          `;
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Error: ${data.message}</div>`;
        }
      } catch (e) {
        resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Error procesando archivo: ${e.message}</div>`;
      }
    }
    
    // Funciones para Afecciones
    async function analizarAfeccionesDesdeRef() {
      const ref = document.getElementById('afeccionesRefInput').value.trim();
      if (!ref) {
        alert('‚ö†Ô∏è Por favor, introduce una referencia catastral');
        return;
      }
      
      const resultDiv = document.getElementById('afeccionesResult');
      resultDiv.innerHTML = '‚è≥ Analizando afecciones...';
      
      try {
        const res = await fetch('/api/v1/analizar-afecciones', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ referencia: ref })
        });
        
        const data = await res.json();
        if (data.status === 'success') {
          let html = '<div style="background: #ffebee; padding: 10px; border-radius: 4px; color: #333;"><strong>‚úÖ An√°lisis completado</strong><br>';
          data.data.afecciones.forEach(a => {
            html += `<div style="margin-top: 8px; padding: 5px; background: rgba(255,255,255,0.7); border-radius: 3px;">
              <strong>‚ö†Ô∏è ${a.tipo}:</strong> ${a.afectacion} (${a.porcentaje?.toFixed(2)}%)
            </div>`;
          });
          html += '</div>';
          resultDiv.innerHTML = html;
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Error: ${data.message}</div>`;
        }
      } catch (e) {
        resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Error de conexi√≥n: ${e.message}</div>`;
      }
    }
    
    async function analizarAfeccionesDesdeArchivo() {
      const fileInput = document.getElementById('fileAfecciones');
      const resultDiv = document.getElementById('afeccionesResult');
      
      if (fileInput.files.length === 0) {
        alert('‚ö†Ô∏è Por favor, selecciona uno o m√°s archivos vectoriales');
        return;
      }
      
      resultDiv.innerHTML = '‚è≥ Procesando archivos...';
      
      try {
        const formData = new FormData();
        for (let file of fileInput.files) {
          formData.append('files', file);
        }
        
        const res = await fetch('/api/v1/analizar-afecciones-archivo', {
          method: 'POST',
          body: formData
        });
        
        const data = await res.json();
        if (data.status === 'success') {
          let html = '<div style="background: #ffebee; padding: 10px; border-radius: 4px; color: #333;"><strong>‚úÖ An√°lisis completado desde archivos</strong><br>';
          data.data.afecciones.forEach(a => {
            html += `<div style="margin-top: 8px; padding: 5px; background: rgba(255,255,255,0.7); border-radius: 3px;">
              <strong>‚ö†Ô∏è ${a.tipo}:</strong> ${a.descripcion}
            </div>`;
          });
          html += '</div>';
          resultDiv.innerHTML = html;
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Error: ${data.message}</div>`;
        }
      } catch (e) {
        resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Error procesando archivos: ${e.message}</div>`;
      }
    }

    // --- FUNCI√ìN PARA MEDIR DISTANCIA ---
    function toggleMeasureDistance() {
      limpiarMapa();
      if (!map.hasLayer(drawingLayer)) {
        drawingLayer.addTo(map);
      }

      // Activar modo de medici√≥n de distancia
      points = [];
      map.on('click', onMapClickDistance);

      // Mostrar instrucci√≥n
      const instructionTooltip = L.tooltip({
        permanent: true,
        direction: 'top',
        className: 'measurement-tooltip'
      }).setLatLng(map.getCenter()).setContent('üìè Haz clic para medir distancias').addTo(map);

      setTimeout(() => {
        map.removeLayer(instructionTooltip);
      }, 3000);
    }

    function onMapClickDistance(e) {
      points.push(e.latlng);

      if (points.length > 1) {
        // Dibujar l√≠nea
        L.polyline(points, {
          color: '#3b82f6',
          weight: 3
        }).addTo(drawingLayer);

        // Calcular distancia total
        let totalDistance = 0;
        for (let i = 1; i < points.length; i++) {
          totalDistance += points[i - 1].distanceTo(points[i]);
        }

        // Mostrar resultado
        const resultEl = document.getElementById('measurement-result');
        resultEl.style.display = 'block';
        resultEl.innerHTML = `üìè Distancia: ${(totalDistance).toFixed(1)} metros`;

        // Limpiar puntos para nueva medici√≥n
        points = [e.latlng];
      }

      // A√±adir marcador
      L.circleMarker(e.latlng, {
        radius: 5,
        color: '#3b82f6',
        fillColor: '#3b82f6',
        fillOpacity: 1
      }).addTo(drawingLayer);
    }

    // --- FUNCI√ìN PARA MEDICI√ìN DE √ÅREA ---
    function toggleMeasureArea() {
      limpiarMapa();
      if (!map.hasLayer(drawingLayer)) {
        drawingLayer.addTo(map);
      }

      // Activar modo de medici√≥n de √°rea
      points = [];
      map.on('click', onMapClickArea);

      // Mostrar instrucci√≥n
      const instructionTooltip = L.tooltip({
        permanent: true,
        direction: 'top',
        className: 'measurement-tooltip'
      }).setLatLng(map.getCenter()).setContent('üìê Haz clic para medir √°reas').addTo(map);

      setTimeout(() => {
        map.removeLayer(instructionTooltip);
      }, 3000);
    }

    function onMapClickArea(e) {
      points.push(e.latlng);

      if (points.length > 2) {
        // Dibujar pol√≠gono
        L.polygon(points, {
          color: '#10b981',
          fillColor: '#10b981',
          fillOpacity: 0.3,
          weight: 3
        }).addTo(drawingLayer);

        // Calcular √°rea
        let area = L.GeometryUtil.geodesicArea(points);

        // Formatear √°rea
        let areaText = '';
        if (area < 1000) {
          areaText = `${area.toFixed(1)} m¬≤`;
        } else if (area < 10000) {
          areaText = `${(area / 1000).toFixed(2)} mil m¬≤`;
        } else if (area < 1000000) {
          areaText = `${(area / 10000).toFixed(2)} ha`;
        } else {
          areaText = `${(area / 1000000).toFixed(2)} km¬≤`;
        }

        // Mostrar resultado
        const resultEl = document.getElementById('measurement-result');
        resultEl.style.display = 'block';
        resultEl.innerHTML = `üìê √Årea: ${areaText}`;

        // Limpiar para nueva medici√≥n
        points = [];
      }

      // A√±adir marcador
      L.circleMarker(e.latlng, {
        radius: 5,
        color: '#10b981',
        fillColor: '#10b981',
        fillOpacity: 1
      }).addTo(drawingLayer);
    }

    // --- FUNCI√ìN PARA LIMPIAR MAPA ---
    function limpiarMapa() {
      drawingLayer.clearLayers();
      points = [];
      map.off('click', onMapClickDistance);
      map.off('click', onMapClickArea);
      document.getElementById('measurement-result').style.display = 'none';
    }
    function switchInternalTab(tab) {
      // Ocultar todos los tabs
      document.querySelectorAll('.tab-content').forEach(el => {
        el.style.display = 'none';
        el.classList.remove('active');
      });

      // Ocultar todos los botones
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Mostrar tab seleccionado
      const tabEl = document.getElementById(`tab-${tab}`);
      if (tabEl) {
        tabEl.style.display = 'block';
        tabEl.classList.add('active');
      }

      // Marcar bot√≥n activo
      const btns = document.querySelectorAll('.tab-btn');
      const tabMap = { 'referencia': 0, 'urbanismo': 1, 'afecciones': 2, 'pdf': 3 };
      if (tabMap[tab] !== undefined) {
        btns[tabMap[tab]].classList.add('active');
      }
    }

    // --- FUNCI√ìN PARA CARGAR REFERENCIA CATASTRAL ---
    function cargarReferenciaCatastral() {
      const ref = document.getElementById('refInput').value.trim();
      if (!ref) {
        alert('Por favor, introduce una referencia catastral');
        return;
      }

      // Mostrar tab de referencia
      switchInternalTab('referencia');

      // Cargar la referencia (usar funci√≥n existente)
      loadSingleReference(ref);
    }

    // --- FUNCI√ìN PARA ANALIZAR URBANISMO ---
    function analizarUrbanismo() {
      const ref = document.getElementById('refInput').value.trim();
      if (!ref) {
        alert('Por favor, introduce una referencia catastral primero');
        return;
      }

      const resultEl = document.getElementById('urbanismoResult');
      resultEl.innerHTML = '‚è≥ Analizando urbanismo...';

      fetch('/api/v1/analizar-urbanismo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ referencia: ref })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            resultEl.innerHTML = `‚úÖ An√°lisis completado<br><small>${data.message || 'Procesado correctamente'}</small>`;
          } else {
            resultEl.innerHTML = `‚ùå Error: ${data.error || 'Error desconocido'}`;
          }
        })
        .catch(error => {
          resultEl.innerHTML = `‚ùå Error: ${error.message}`;
        });
    }

    // --- FUNCI√ìN PARA ANALIZAR AFECIONES ---
    function analizarAfecciones() {
      const ref = document.getElementById('refInput').value.trim();
      if (!ref) {
        alert('Por favor, introduce una referencia catastral primero');
        return;
      }

      const resultEl = document.getElementById('afeccionesResult');
      resultEl.innerHTML = '‚è≥ Analizando afecciones...';

      fetch('/api/v1/analizar-afecciones', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ referencia: ref })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            resultEl.innerHTML = `‚úÖ An√°lisis completado<br><small>${data.message || 'Procesado correctamente'}</small>`;
          } else {
            resultEl.innerHTML = `‚ùå Error: ${data.error || 'Error desconocido'}`;
          }
        })
        .catch(error => {
          resultEl.innerHTML = `‚ùå Error: ${error.message}`;
        });
    }

    // --- FUNCI√ìN PARA GENERAR PDF ---
    function generarPDF() {
      const ref = document.getElementById('refInput').value.trim();
      if (!ref) {
        alert('Por favor, introduce una referencia catastral primero');
        return;
      }

      const resultEl = document.getElementById('pdfResult');
      resultEl.innerHTML = '‚è≥ Generando PDF...';

      fetch('/api/v1/generar-pdf-completo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          referencia: ref,
          incluir_referencia: true,
          incluir_urbanismo: false,
          incluir_afecciones: false,
          formato: 'pdf'
        })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            resultEl.innerHTML = `‚úÖ PDF generado<br><small>${data.message || 'PDF creado correctamente'}</small>`;
            // Opcional: abrir PDF en nueva ventana
            if (data.url) {
              window.open(data.url, '_blank');
            }
          } else {
            resultEl.innerHTML = `‚ùå Error: ${data.error || 'Error desconocido'}`;
          }
        })
        .catch(error => {
          resultEl.innerHTML = `‚ùå Error: ${error.message}`;
        });
    }
    function activarArea() {
      limpiarMapa();
      if (!map.hasLayer(drawingLayer)) {
        drawingLayer.addTo(map);
      }

      // Crear tooltip de instrucci√≥n
      const instructionTooltip = L.tooltip({
        permanent: true,
        direction: 'top',
        className: 'measurement-tooltip'
      }).setLatLng(map.getCenter()).setContent('üìê Haz clic para definir v√©rtices. Doble clic para cerrar.').addTo(map);

      setTimeout(() => {
        map.removeLayer(instructionTooltip);
      }, 3000);

      map.on('click', onMapClickArea);
    }

    function onMapClickArea(e) {
      points.push(e.latlng);

      if (points.length > 2) {
        if (tempShape) {
          drawingLayer.removeLayer(tempShape);
        }

        tempShape = L.polygon(points, {
          color: '#10b981',
          fillColor: '#10b981',
          fillOpacity: 0.3,
          weight: 3
        }).addTo(drawingLayer);

        // Calcular √°rea usando L.GeometryUtil
        let area = L.GeometryUtil.geodesicArea(points);

        tempShape.bindTooltip((area / 10000).toFixed(2) + " ha", {
          permanent: true,
          direction: 'center',
          className: 'measurement-tooltip-area'
        }).openTooltip();
      }

      L.circleMarker(e.latlng, {
        radius: 5,
        color: '#10b981',
        fillColor: '#10b981',
        fillOpacity: 1
      }).addTo(drawingLayer);
    }

    function onMouseMove(e) {
      // Implementar si se necesita vista previa
    }

    // --- FUNCI√ìN PARA CARGAR ARCHIVOS ---
    function setupFileUpload() {
      const fileInput = document.getElementById('fileInput');
      const uploadArea = document.querySelector('.upload-area');

      // Click en el bot√≥n de cargar
      fileInput.addEventListener('change', handleFileSelect);

      // Drag and drop
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'rgba(99, 102, 241, 0.8)';
        uploadArea.style.background = 'rgba(255, 255, 255, 1)';
      });

      uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'rgba(99, 102, 241, 0.3)';
        uploadArea.style.background = 'rgba(255, 255, 255, 0.9)';
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'rgba(99, 102, 241, 0.3)';
        uploadArea.style.background = 'rgba(255, 255, 255, 0.9)';

        const files = e.dataTransfer.files;
        handleFiles(files);
      });
    }

    function handleFileSelect(e) {
      const files = e.target.files;
      handleFiles(files);
    }

    async function handleFiles(files) {
      for (let file of files) {
        const extension = file.name.split('.').pop().toLowerCase();

        try {
          if (extension === 'kml') {
            await loadKMLFile(file);
          } else if (extension === 'gml') {
            await loadGMLFile(file);
          } else if (extension === 'geojson' || extension === 'json') {
            await loadGeoJSONFile(file);
          } else if (extension === 'zip') {
            await loadShapefileZip(file);
          } else {
            alert(`Formato no soportado: ${extension}`);
          }
        } catch (error) {
          console.error(`Error cargando ${file.name}:`, error);
          alert(`Error cargando ${file.name}: ${error.message}`);
        }
      }
    }

    async function loadKMLFile(file) {
      const text = await file.text();
      // Convertir KML a GeoJSON (simplificado)
      const parser = new DOMParser();
      const kmlDoc = parser.parseFromString(text, 'text/xml');

      // Extraer coordenadas del KML (implementaci√≥n b√°sica)
      const coordinates = kmlDoc.getElementsByTagName('coordinates');
      if (coordinates.length > 0) {
        const coords = coordinates[0].textContent.trim().split(' ');
        const latlngs = coords.map(coord => {
          const [lng, lat] = coord.split(',').map(Number);
          return [lat, lng];
        });

        // Crear capa con contorno permanente
        const kmlLayer = L.polyline(latlngs, {
          color: '#ff6b6b',
          weight: 3,
          opacity: 0.9,
          fill: false,
          dashArray: null
        }).addTo(map);

        // A√±adir marcadores en los v√©rtices para mayor visibilidad
        latlngs.forEach(latlng => {
          L.circleMarker(latlng, {
            radius: 4,
            color: '#ff6b6b',
            fillColor: '#ff6b6b',
            fillOpacity: 1,
            weight: 2
          }).addTo(map);
        });

        kmlLayer.bindPopup(`KML: ${file.name}<br>Puntos: ${latlngs.length}`);

        // Guardar referencia para poder limpiar despu√©s
        if (!window.loadedLayers) window.loadedLayers = [];
        window.loadedLayers.push(kmlLayer);

        map.fitBounds(L.latLngBounds(latlngs).pad(0.1));
      }
    }

    async function loadGMLFile(file) {
      const text = await file.text();
      // Para GML, necesitar√≠amos una librer√≠a m√°s compleja
      // Por ahora, mostrar mensaje
      alert(`Archivo GML cargado: ${file.name}\n\nPara GML se requiere procesamiento adicional.`);
    }

    async function loadGeoJSONFile(file) {
      const text = await file.text();
      const geojson = JSON.parse(text);

      const geojsonLayer = L.geoJSON(geojson, {
        style: function (feature) {
          return {
            color: '#4ecdc4',
            weight: 3,
            opacity: 0.9,
            fillOpacity: 0.3,
            fillColor: '#4ecdc4',
            dashArray: null
          };
        },
        pointToLayer: function (feature, latlng) {
          return L.circleMarker(latlng, {
            radius: 6,
            color: '#4ecdc4',
            fillColor: '#4ecdc4',
            fillOpacity: 1,
            weight: 3
          });
        },
        onEachFeature: function (feature, layer) {
          if (feature.properties) {
            const popupContent = Object.entries(feature.properties)
              .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
              .join('<br>');
            layer.bindPopup(`${file.name}<br><br>${popupContent}`);
          }

          // Asegurar que el contorno sea permanente
          if (feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon') {
            layer.setStyle({
              weight: 3,
              opacity: 0.9,
              color: '#4ecdc4',
              fillOpacity: 0.3
            });
          }
        }
      }).addTo(map);

      // Guardar referencia para poder limpiar despu√©s
      if (!window.loadedLayers) window.loadedLayers = [];
      window.loadedLayers.push(geojsonLayer);

      // Ajustar vista a los datos cargados
      if (geojsonLayer.getBounds().isValid()) {
        map.fitBounds(geojsonLayer.getBounds().pad(0.1));
      }
    }

    async function loadShapefileZip(file) {
      alert(`Archivo Shapefile ZIP detectado: ${file.name}\n\nPara Shapefiles se requiere librer√≠a adicional (shapefile.js).`);
    }

    function cargarReferenciaCatastral() {
      const referencia = prompt('Introduce la referencia catastral (ej: 9872303VH5797S0001WX):');
      if (referencia) {
        loadSingleReference(referencia);
      }
    }

    // single loadSingleReference implementation is defined earlier (handles Point and Polygon)

    // DESHABILITADO: Esta inicializaci√≥n duplica DOMContentLoaded (l√≠nea 786)\r\n    // window.addEventListener('load', () => {\r\n    //   try {\r\n    //     switchTab('visor');\r\n    //     setupFileUpload(); // Inicializar carga de archivos\r\n    //   } catch (e) {\r\n    //     console.error('Error inicializando pesta√±as:', e);\r\n    //     initMap();\r\n    //   }\r\n    // });
  </script>
  <script src="/static/js/visor_logic.js"></script>
</body>

</html>